# é¡¹ç›®æ‰“åŒ…æ•™ç¨‹

## æ¦‚è¿°

UnifyPy 2.0æ˜¯ä¸€ä¸ªä¼ä¸šçº§è·¨å¹³å°Pythonåº”ç”¨æ‰“åŒ…è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå°†Pythoné¡¹ç›®æ‰“åŒ…ä¸ºWindowsã€macOSã€Linuxå¹³å°çš„åŸç”Ÿå®‰è£…åŒ…ã€‚ç›¸æ¯”1.0ç‰ˆæœ¬ï¼Œ2.0ç‰ˆæœ¬å¼•å…¥äº†å¹¶è¡Œæ„å»ºã€æ™ºèƒ½è·¯å¾„å¤„ç†ã€ä¼ä¸šçº§å›æ»šç³»ç»Ÿç­‰æ–°ç‰¹æ€§ã€‚å°æ™ºå®¢æˆ·ç«¯å·²é…ç½®äº†ç›¸åº”çš„æ‰“åŒ…é…ç½®æ–‡ä»¶ï¼Œæœ¬æ•™ç¨‹å°†æŒ‡å¯¼æ‚¨å¦‚ä½•ä½¿ç”¨UnifyPy 2.0è¿›è¡Œæ‰“åŒ…ã€‚

### âœ¨ UnifyPy 2.0 æ–°ç‰¹æ€§

- **ğŸ”„ è·¨å¹³å°æ”¯æŒ**: Windows (EXE)ã€macOS (DMG)ã€Linux (DEB)
- **ğŸ›¡ï¸ ä¼ä¸šçº§åŠŸèƒ½**: è‡ªåŠ¨å›æ»šã€ä¼šè¯ç®¡ç†ã€æ™ºèƒ½é”™è¯¯å¤„ç†
- **ğŸ¨ ä¼˜ç§€ä½“éªŒ**: Richè¿›åº¦æ¡ã€åˆ†é˜¶æ®µæ˜¾ç¤ºã€è¯¦ç»†æ—¥å¿—
- **ğŸ“Š æ™ºèƒ½è·¯å¾„å¤„ç†**: ç›¸å¯¹è·¯å¾„è‡ªåŠ¨è§£æä¸ºç»å¯¹è·¯å¾„
- **ğŸ macOSæƒé™ç®¡ç†**: è‡ªåŠ¨ç”Ÿæˆæƒé™æ–‡ä»¶ã€ä»£ç ç­¾åæ”¯æŒ

## å‡†å¤‡å·¥ä½œ

### 1. å®‰è£…py-xiaozhié¡¹ç›®ä¾èµ–

é¦–å…ˆç¡®ä¿æ‚¨å·²æ¿€æ´»äº†py-xiaozhié¡¹ç›®çš„Pythonç¯å¢ƒï¼Œå¹¶å®‰è£…æ‰€æœ‰é¡¹ç›®ä¾èµ–ï¼š

```bash
# è¿›å…¥py-xiaozhié¡¹ç›®ç›®å½•
cd /path/to/py-xiaozhi

# æ ¹æ®å¹³å°å®‰è£…é¡¹ç›®ä¾èµ–
pip install -r requirements.txt        # Windows/Linux
# æˆ–
pip install -r requirements_mac.txt    # macOS
```

### 2. åœ¨é¡¹ç›®ç¯å¢ƒä¸­å®‰è£…UnifyPyä¾èµ–

åœ¨åŒä¸€ä¸ªç¯å¢ƒä¸­å®‰è£…UnifyPyæ‰€éœ€çš„ä¾èµ–ï¼š

- ç†è®ºä¸Šå®‰è£…py-xiaozhiçš„ç¯å¢ƒé»˜è®¤å°±è‡ªå¸¦äº†ï¼Œå¦‚æœä¸è¡Œå°±é‡æ–°æ‰§è¡Œä¸‹

```bash
# ä¸€é”®å®‰è£…UnifyPyæ‰€éœ€çš„æ‰€æœ‰ä¾èµ–
pip install pyinstaller==6.15.0 rich==14.1.0 requests==2.32.3 packaging==25.0 pillow==11.3.0
```

### 3. è·å–UnifyPy 2.0

```bash
# å…‹éš†UnifyPyä»“åº“ï¼ˆå»ºè®®æ”¾åœ¨å’Œpy-xiaozhiåŒçº§ç›®å½•ï¼‰
git clone https://github.com/huangjunsen0406/UnifyPy.git
```

### 4. éªŒè¯ç¯å¢ƒé…ç½®

éªŒè¯æ‰€æœ‰ä¾èµ–éƒ½åœ¨å½“å‰ç¯å¢ƒä¸­æ­£å¸¸å·¥ä½œï¼š

```bash
# éªŒè¯UnifyPyä¾èµ–
python -c "import pyinstaller, rich, requests, packaging, pillow; print('âœ… UnifyPyä¾èµ–å®‰è£…æˆåŠŸ')"

# éªŒè¯py-xiaozhié¡¹ç›®ä¾èµ–ï¼ˆæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
python -c "import numpy, PyQt5; print('âœ… py-xiaozhié¡¹ç›®ä¾èµ–å¯ç”¨')"

# æ˜¾ç¤ºå½“å‰ç¯å¢ƒä¿¡æ¯
echo "å½“å‰ç¯å¢ƒ: $(which python)"
echo "Pythonç‰ˆæœ¬: $(python --version)"
```

### ä¸ºä»€ä¹ˆè¦åœ¨åŒä¸€ç¯å¢ƒå®‰è£…ï¼Ÿ

UnifyPyä½¿ç”¨PyInstalleræ‰“åŒ…ï¼Œéœ€è¦è®¿é—®å½“å‰ç¯å¢ƒä¸­çš„æ‰€æœ‰PythonåŒ…è¿›è¡Œä¾èµ–åˆ†æã€‚å¦‚æœä¾èµ–åˆ†æ•£åœ¨ä¸åŒç¯å¢ƒä¸­ï¼ŒPyInstalleræ— æ³•æ­£ç¡®æ‰“åŒ…ã€‚

### 3. å®‰è£…å¹³å°ç‰¹å®šå·¥å…·

#### Windowså¹³å°

- å®‰è£…[Inno Setup](https://jrsoftware.org/isdl.php)ï¼ˆç”¨äºåˆ›å»ºå®‰è£…ç¨‹åºï¼‰
- å®‰è£…åï¼Œåœ¨build.jsonä¸­é…ç½®Inno Setupè·¯å¾„ï¼Œæˆ–è®¾ç½®ç¯å¢ƒå˜é‡INNO_SETUP_PATH
- æŠŠUnifyPyä¸‹çš„ChineseSimplified.islå¤åˆ¶åˆ°inno setupå®‰è£…ç›®å½•ä¸‹languageé‡Œ ï¼ˆwindowsï¼‰

#### macOSå¹³å°

- UnifyPy 2.0å†…ç½®äº†create-dmgå·¥å…·ï¼Œæ— éœ€å•ç‹¬å®‰è£…

#### Linuxå¹³å°

å®‰è£…DEBæ‰“åŒ…å·¥å…·ï¼š

```bash
# DEBæ ¼å¼(Debian/Ubuntu)
sudo apt-get install dpkg-dev fakeroot
```

**Linuxç¼–è¯‘ç¯å¢ƒå‡†å¤‡**ï¼ˆé‡è¦ï¼‰ï¼š

```bash
# å®‰è£…å¿…è¦çš„å¼€å‘å·¥å…·å’Œåº“
sudo apt update
sudo apt install -y build-essential python3-dev python3-pip python3-setuptools \
    libopenblas-dev liblapack-dev gfortran patchelf autoconf automake \
    libtool cmake libssl-dev libatlas-base-dev

# å®‰è£…ç°ä»£æ„å»ºç³»ç»Ÿ
pip install meson ninja
sudo apt install -y meson ninja-build
```

## æ‰“åŒ…é…ç½®è¯¦è§£

å°æ™ºå®¢æˆ·ç«¯å·²ç»æä¾›äº†é¢„é…ç½®çš„`build.json`æ–‡ä»¶ã€‚UnifyPy 2.0æ”¯æŒæ›´ä¸°å¯Œçš„é…ç½®é€‰é¡¹å’Œæ™ºèƒ½è·¯å¾„å¤„ç†ï¼Œä»¥ä¸‹æ˜¯å„é…ç½®é¡¹çš„è¯¦ç»†è¯´æ˜ï¼š

### æ™ºèƒ½è·¯å¾„å¤„ç†

UnifyPy 2.0å¼•å…¥äº†æ™ºèƒ½è·¯å¾„å¤„ç†åŠŸèƒ½ï¼Œé…ç½®æ–‡ä»¶ä¸­çš„ç›¸å¯¹è·¯å¾„ä¼šè‡ªåŠ¨è§£æä¸ºç›¸å¯¹äº**ç›®æ ‡é¡¹ç›®ç›®å½•**çš„ç»å¯¹è·¯å¾„ï¼š

- âœ… `"icon": "assets/icon.png"` â†’ `/path/to/project/assets/icon.png`  
- âœ… `"add_data": ["data:data"]` â†’ `/path/to/project/data:data`
- âœ… æ”¯æŒåµŒå¥—é…ç½®å’Œå¹³å°ç‰¹å®šè·¯å¾„

### åŸºæœ¬é…ç½®

```json
{
    "name": "xiaozhi",                  // åº”ç”¨ç¨‹åºåç§°ï¼Œå°†ç”¨äºå¯æ‰§è¡Œæ–‡ä»¶å’Œå®‰è£…ç¨‹åºåç§°
    "version": "1.0.0",                 // åº”ç”¨ç¨‹åºç‰ˆæœ¬å·
    "publisher": "Junsen",              // å‘å¸ƒè€…åç§°
    "entry": "main.py",                 // ç¨‹åºå…¥å£æ–‡ä»¶
    "icon": "assets/xiaozhi_icon.ico",  // åº”ç”¨å›¾æ ‡è·¯å¾„
    "hooks": "hooks",                   // PyInstalleré’©å­ç›®å½•
    "onefile": false,                   // æ˜¯å¦ç”Ÿæˆå•æ–‡ä»¶æ¨¡å¼çš„å¯æ‰§è¡Œæ–‡ä»¶
    
    // PyInstalleré€šç”¨å‚æ•°ï¼Œé€‚ç”¨äºæ‰€æœ‰å¹³å°
    "additional_pyinstaller_args": "--add-data assets;assets --add-data libs;libs --add-data src;src --add-data models;models --hidden-import=PyQt5",
    
    // Inno Setupè·¯å¾„ï¼ˆWindowså¹³å°éœ€è¦ï¼‰
    "inno_setup_path": "E:\\application\\Inno Setup 6\\ISCC.exe",
    
    // å…¶ä»–é…ç½®...
}
```

> **æ³¨æ„**ï¼šJSONæ–‡ä»¶ä¸æ”¯æŒæ³¨é‡Šï¼Œä¸Šè¿°ä»£ç ä¸­çš„æ³¨é‡Šä»…ç”¨äºè¯´æ˜ï¼Œå®é™…é…ç½®æ–‡ä»¶ä¸­ä¸åº”åŒ…å«æ³¨é‡Šã€‚

### å¹³å°ç‰¹å®šé…ç½®

#### Windowså¹³å°é…ç½®

```json
"windows": {
    "format": "exe",                  // è¾“å‡ºæ ¼å¼
    "additional_pyinstaller_args": "--add-data assets;assets --add-data libs;libs --add-data src;src --add-data models;models --hidden-import=PyQt5 --noconsole",
    "desktop_entry": true,            // æ˜¯å¦åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
    "installer_options": {
        "languages": ["ChineseSimplified", "English"],  // å®‰è£…ç¨‹åºæ”¯æŒçš„è¯­è¨€
        "license_file": "LICENSE",                      // è®¸å¯è¯æ–‡ä»¶
        "readme_file": "README.md",                     // è‡ªè¿°æ–‡ä»¶
        "create_desktop_icon": true,                    // æ˜¯å¦åˆ›å»ºæ¡Œé¢å›¾æ ‡
        "allow_run_after_install": true                 // å®‰è£…åæ˜¯å¦å…è®¸ç«‹å³è¿è¡Œ
    }
}
```

#### Linuxå¹³å°é…ç½®

```json
"linux": {
    "format": "deb",                  // è¾“å‡ºæ ¼å¼ï¼šdeb
    "desktop_entry": true,            // æ˜¯å¦åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
    "categories": "Utility;Development;",  // åº”ç”¨ç¨‹åºç±»åˆ«
    "description": "å°æ™ºAiå®¢æˆ·ç«¯",          // åº”ç”¨æè¿°
    "requires": "libc6,libgtk-3-0,libx11-6,libopenblas-dev",  // ä¾èµ–é¡¹
    "additional_pyinstaller_args": "--add-data assets:assets --add-data libs:libs --add-data src:src --add-data models:models --hidden-import=PyQt5"
}
```

#### macOSå¹³å°é…ç½®

```json
"macos": {
    "format": "app",                  // è¾“å‡ºæ ¼å¼ï¼Œå¯é€‰å€¼ï¼šapp, dmg
    "additional_pyinstaller_args": "--add-data assets:assets --add-data libs:libs --add-data src:src --add-data models:models --hidden-import=PyQt5 --windowed",
    "app_bundle_name": "XiaoZhi.app", // åº”ç”¨åŒ…åç§°
    "bundle_identifier": "com.junsen.xiaozhi",  // åº”ç”¨æ ‡è¯†ç¬¦
    "sign_bundle": false,             // æ˜¯å¦ç­¾ååº”ç”¨åŒ…
    "create_dmg": true,               // æ˜¯å¦åˆ›å»ºDMGé•œåƒ
    "installer_options": {
        "license_file": "LICENSE",    // è®¸å¯è¯æ–‡ä»¶
        "readme_file": "README.md"    // è‡ªè¿°æ–‡ä»¶
    }
}
```

### å…¶ä»–é‡è¦é…ç½®é¡¹

```json
"build_installer": true  // æ˜¯å¦æ„å»ºå®‰è£…ç¨‹åºï¼Œè®¾ä¸ºfalseåªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
```

> **æç¤º**ï¼šUnifyPyè‡ªåŠ¨ç”Ÿæˆçš„`.unifypy`æ–‡ä»¶å¤¹åŒ…å«æ‰€æœ‰å¹³å°çš„æ‰“åŒ…é…ç½®ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ã€‚å¦‚éœ€è‡ªå®šä¹‰ï¼Œå¯ç›´æ¥ç¼–è¾‘å¯¹åº”å¹³å°çš„é…ç½®æ–‡ä»¶ã€‚

### Windowsåº”ç”¨ç¨‹åºæ ‡è¯†ç¬¦(AppId)ç®¡ç†

UnifyPy 2.0ä¼šè‡ªåŠ¨ç®¡ç†Windowså®‰è£…ç¨‹åºçš„AppIdï¼Œæ— éœ€æ‰‹åŠ¨ä¿®æ”¹æ¨¡æ¿æ–‡ä»¶ã€‚

#### è‡ªåŠ¨ç”Ÿæˆæœºåˆ¶

ç¬¬ä¸€æ¬¡æ‰“åŒ…æ—¶ï¼ŒUnifyPyä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•è‡ªåŠ¨åˆ›å»º`.unifypy`æ–‡ä»¶å¤¹ï¼ŒåŒ…å«å„å¹³å°çš„é…ç½®æ–‡ä»¶ï¼š

```
é¡¹ç›®ç›®å½•/
â”œâ”€â”€ .unifypy/
â”‚   â”œâ”€â”€ cache/             # æ„å»ºç¼“å­˜
â”‚   â”œâ”€â”€ linux/
â”‚   â”‚   â”œâ”€â”€ app.desktop    # Linuxæ¡Œé¢æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ control        # DEBåŒ…æ§åˆ¶æ–‡ä»¶
â”‚   â”œâ”€â”€ macos/
â”‚   â”‚   â”œâ”€â”€ dmg_config.json # DMGé…ç½®
â”‚   â”‚   â””â”€â”€ Info.plist     # macOSåº”ç”¨ä¿¡æ¯
â”‚   â”œâ”€â”€ windows/
â”‚   â”‚   â””â”€â”€ setup.iss      # Inno Setupè„šæœ¬(åŒ…å«AppId)
â”‚   â”œâ”€â”€ .gitignore         # Gitå¿½ç•¥è§„åˆ™
â”‚   â””â”€â”€ metadata.json      # é¡¹ç›®å…ƒæ•°æ®
â”œâ”€â”€ build.json
â””â”€â”€ main.py
```

#### è‡ªå®šä¹‰AppIdï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ä½¿ç”¨ä¼ä¸šç‰¹å®šçš„AppIdï¼Œå¯ä»¥åœ¨é¦–æ¬¡æ‰“åŒ…å‰æ‰‹åŠ¨ç¼–è¾‘`.unifypy/windows/setup.iss`æ–‡ä»¶ï¼š

```ini
[Setup]
AppId={{{æ‚¨çš„ä¼ä¸šGUID}}}  ; æ›¿æ¢ä¸ºä¼ä¸šè‡ªå®šä¹‰GUID
AppName=å°æ™º
AppVersion=1.0.0
; ...(å…¶ä»–é…ç½®)
```

**æˆ–è€…åœ¨`metadata.json`ä¸­é…ç½®**ï¼š

```json
{
  "project_name": "xiaozhi",
  "app_id": "{æ‚¨çš„ä¼ä¸šGUID}",
  "created_date": "2024-01-01T00:00:00Z",
  "last_modified": "2024-01-01T00:00:00Z"
}
```

**è·å–ä¼ä¸šGUIDçš„æ–¹å¼**ï¼š

- åœ¨çº¿ç”Ÿæˆå·¥å…·ï¼š[Online GUID Generator](https://www.guidgenerator.com/)
- Visual Studioå‘½ä»¤ï¼š`Tools > Create GUID`
- PowerShellå‘½ä»¤ï¼š`[System.Guid]::NewGuid()`

#### æ–‡ä»¶ç®¡ç†å»ºè®®

1. **ç‰ˆæœ¬æ§åˆ¶**ï¼šå°†`.unifypy`æ–‡ä»¶å¤¹åŠ å…¥Gitç‰ˆæœ¬æ§åˆ¶ï¼Œä½†æ’é™¤ç¼“å­˜ç›®å½•ï¼š

   ```gitignore
   # åœ¨é¡¹ç›®æ ¹ç›®å½•çš„.gitignoreä¸­æ·»åŠ 
   .unifypy/cache/
   ```

2. **AppIdç®¡ç†**ï¼šä¸€æ—¦ç”ŸæˆAppIdï¼Œå»ºè®®ä¸è¦éšæ„æ›´æ”¹ï¼Œä»¥é¿å…å®‰è£…ç¨‹åºå‡çº§æ—¶çš„å†²çªé—®é¢˜

3. **å›¢é˜Ÿåä½œ**ï¼šç¡®ä¿æ‰€æœ‰å›¢é˜Ÿæˆå‘˜ä½¿ç”¨ç›¸åŒUnifyPyé…ç½®ï¼Œç‰¹åˆ«æ˜¯Windowsçš„AppId

## æ‰§è¡Œæ‰“åŒ…

### ç¯å¢ƒå‡†å¤‡

**é‡è¦**ï¼šæ‰“åŒ…å‰ç¡®ä¿UnifyPyå’Œç›®æ ‡é¡¹ç›®åœ¨åŒä¸€ç¯å¢ƒä¸­ï¼š

```bash
# æ¿€æ´»ç»Ÿä¸€ç¯å¢ƒ
conda activate packaging-env  # æˆ– source build_env/bin/activate

# éªŒè¯ç¯å¢ƒ
which python
python -c "import rich, requests, numpy, PyQt5; print('Environment ready')"
```

### UnifyPy 2.0 åŸºæœ¬æ‰“åŒ…å‘½ä»¤

å»ºè®®UnifyPyæ”¾åœ¨å’Œpy-xiaozhié¡¹ç›®åŒçº§ç›®å½•ä¸‹ï¼š

```bash
# åŸºæœ¬æ‰“åŒ…ï¼ˆæ¨èï¼‰
python ../UnifyPy/main.py . --config build.json

# è¯¦ç»†è¾“å‡ºæ¨¡å¼
python ../UnifyPy/main.py . --config build.json --verbose

# æ¸…ç†é‡æ–°æ„å»º
python ../UnifyPy/main.py . --config build.json --clean --verbose

# åªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè·³è¿‡å®‰è£…åŒ…
python ../UnifyPy/main.py . --config build.json --skip-installer

# æŒ‡å®šç‰¹å®šæ ¼å¼
python ../UnifyPy/main.py . --config build.json --format exe   # Windows
python ../UnifyPy/main.py . --config build.json --format dmg   # macOS  
python ../UnifyPy/main.py . --config build.json --format deb   # Linux
```

### ä¸»è¦å‘½ä»¤è¡Œé€‰é¡¹

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--clean` | æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶ | `--clean` |
| `--skip-exe` | è·³è¿‡å¯æ‰§è¡Œæ–‡ä»¶æ„å»º | `--skip-exe` |
| `--skip-installer` | è·³è¿‡å®‰è£…ç¨‹åºæ„å»º | `--skip-installer` |
| `--format FORMAT` | æŒ‡å®šè¾“å‡ºæ ¼å¼(exe/dmg/deb) | `--format deb` |
| `--development` | macOSå¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨æƒé™é…ç½®ï¼‰ | `--development` |
| `--list-rollback` | åˆ—å‡ºå¯ç”¨çš„å›æ»šä¼šè¯ | `--list-rollback` |
| `--rollback SESSION_ID` | æ‰§è¡ŒæŒ‡å®šä¼šè¯çš„å›æ»š | `--rollback abc123` |

### é’ˆå¯¹ä¸åŒå¹³å°çš„æ‰“åŒ…å‘½ä»¤

#### Windowså¹³å°

```bash
python C:\è·¯å¾„\åˆ°\UnifyPy\main.py . --config build.json
```

#### macOSå¹³å°

```bash
python /è·¯å¾„/åˆ°/UnifyPy/main.py . --config build.json
```

#### Linuxå¹³å°ï¼ˆDEBæ ¼å¼ï¼‰

1. **å‡†å¤‡ç¯å¢ƒ**

   ```bash
   # æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦çš„ä¾èµ–
   sudo apt update
   sudo apt install -y build-essential python3-dev python3-pip python3-setuptools libopenblas-dev liblapack-dev gfortran patchelf autoconf automake libtool cmake libssl-dev libatlas-base-dev
   ```

2. **æ‰§è¡Œæ‰“åŒ…**

   ç¡®ä¿build.jsonä¸­linux.formatè®¾ç½®ä¸º"deb"ï¼Œç„¶åæ‰§è¡Œï¼š

   ```bash
   python3 /è·¯å¾„/åˆ°/UnifyPy/main.py . --config build.json
   ```

### Linuxå¹³å°ä¾èµ–å¤„ç†æ³¨æ„äº‹é¡¹

**NumPyç¼–è¯‘ç¯å¢ƒé…ç½®ï¼ˆé‡è¦ï¼‰**

**âš ï¸ é‡è¦æé†’**: ä¸è¦åˆ é™¤NumPyï¼æ­£ç¡®çš„åšæ³•æ˜¯ç¡®ä¿ç¼–è¯‘ç¯å¢ƒé…ç½®æ­£ç¡®ã€‚

```bash
# æ–¹æ¡ˆ1: æ¨èæ–¹æ¡ˆ - ç¡®ä¿NumPyä¾èµ–æ­£ç¡®ç¼–è¯‘
# è®¾ç½®ç¯å¢ƒå˜é‡
export BLAS=openblas
export LAPACK=openblas
export NPY_NUM_BUILD_JOBS=$(nproc)  # ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒåŠ é€Ÿç¼–è¯‘

# éªŒè¯å½“å‰NumPyæ˜¯å¦å¯ç”¨
python -c "import numpy; print('NumPy version:', numpy.__version__); print('BLAS info:', numpy.show_config())"

# å¦‚æœä¸Šè¿°å‘½ä»¤æˆåŠŸï¼Œåˆ™æ— éœ€é‡æ–°ç¼–è¯‘
```

**æ›¿ä»£æ–¹æ¡ˆ**: ä½¿ç”¨condaç®¡ç†ä¾èµ–ï¼ˆæ¨èç”¨äºå¤æ‚ç¯å¢ƒï¼‰ï¼š

```bash
# å®‰è£…conda/miniconda
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh

# åˆ›å»ºç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
conda create -n build_env python=3.9
conda activate build_env
conda install numpy scipy openblas-devel
pip install -r requirements.txt
```

## æ‰“åŒ…è¾“å‡º

æˆåŠŸæ‰“åŒ…åï¼Œå°†åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„`dist`æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°æ‰“åŒ…çš„åº”ç”¨ç¨‹åºï¼š

- **Windows**:
  - å¯æ‰§è¡Œæ–‡ä»¶(.exe)ä½äº`dist/xiaozhi`ç›®å½•
  - å®‰è£…ç¨‹åºä½äº`dist/installer`ç›®å½•ï¼Œå‘½åä¸º`xiaozhi-1.0.0-setup.exe`

- **macOS**:
  - åº”ç”¨ç¨‹åºåŒ…(.app)ä½äº`dist/xiaozhi`ç›®å½•
  - ç£ç›˜é•œåƒ(.dmg)ä½äº`dist/installer`ç›®å½•ï¼Œå‘½åä¸º`xiaozhi-1.0.0.dmg`

- **Linux**:
  - å¯æ‰§è¡Œæ–‡ä»¶ä½äº`dist/xiaozhi`ç›®å½•
  - DEBå®‰è£…åŒ…ä½äº`dist/installer`ç›®å½•ï¼š`xiaozhi-1.0.0.deb`

## é«˜çº§é…ç½®é€‰é¡¹

### PyInstallerå‚æ•°

åœ¨`additional_pyinstaller_args`å­—æ®µä¸­ï¼Œæ‚¨å¯ä»¥æ·»åŠ ä»»ä½•PyInstalleræ”¯æŒçš„å‚æ•°ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨å‚æ•°ï¼š

- `--noconsole`: ä¸æ˜¾ç¤ºæ§åˆ¶å°çª—å£ï¼ˆä»…é€‚ç”¨äºå›¾å½¢ç•Œé¢ç¨‹åºï¼‰
- `--windowed`: ç­‰åŒäº`--noconsole`
- `--hidden-import=MODULE`: æ·»åŠ éšå¼å¯¼å…¥çš„æ¨¡å—
- `--add-data SRC;DEST`: æ·»åŠ æ•°æ®æ–‡ä»¶ï¼ˆWindowså¹³å°ä½¿ç”¨åˆ†å·åˆ†éš”ï¼‰
- `--add-data SRC:DEST`: æ·»åŠ æ•°æ®æ–‡ä»¶ï¼ˆmacOS/Linuxå¹³å°ä½¿ç”¨å†’å·åˆ†éš”ï¼‰
- `--icon=FILE.ico`: è®¾ç½®åº”ç”¨ç¨‹åºå›¾æ ‡

### å¤„ç†ç‰¹æ®Šä¾èµ–

æŸäº›Pythonåº“å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†æ‰èƒ½æ­£ç¡®æ‰“åŒ…ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³ï¼š

1. **ä½¿ç”¨é’©å­æ–‡ä»¶**ï¼šåœ¨`hooks`ç›®å½•ä¸­åˆ›å»ºè‡ªå®šä¹‰é’©å­ï¼Œå¤„ç†ç‰¹æ®Šå¯¼å…¥æƒ…å†µ
2. **æ·»åŠ éšå¼å¯¼å…¥**ï¼šä½¿ç”¨`--hidden-import`å‚æ•°æ˜¾å¼åŒ…å«éšå¼å¯¼å…¥çš„æ¨¡å—
3. **æ·»åŠ æ•°æ®æ–‡ä»¶**ï¼šä½¿ç”¨`--add-data`å‚æ•°åŒ…å«ç¨‹åºè¿è¡Œæ‰€éœ€çš„æ•°æ®æ–‡ä»¶

## UnifyPy 2.0 æ–°åŠŸèƒ½è¯¦è§£

### ğŸ”„ å›æ»šç³»ç»Ÿ

UnifyPy 2.0å¼•å…¥äº†ä¼ä¸šçº§å›æ»šç³»ç»Ÿï¼Œè‡ªåŠ¨è·Ÿè¸ªæ„å»ºæ“ä½œï¼š

```bash
# åˆ—å‡ºå¯ç”¨çš„å›æ»šä¼šè¯
python ../UnifyPy/main.py . --list-rollback

# æ‰§è¡Œå›æ»šåˆ°æŒ‡å®šä¼šè¯
python ../UnifyPy/main.py . --rollback SESSION_ID

# ç¦ç”¨è‡ªåŠ¨å›æ»šï¼ˆæå‡æ€§èƒ½ï¼‰
python ../UnifyPy/main.py . --config build.json --no-rollback
```

### ğŸ macOSè‡ªåŠ¨æƒé™ç®¡ç†

UnifyPy 2.0ä¸ºmacOSåº”ç”¨æä¾›å®Œæ•´çš„æƒé™ç®¡ç†æ–¹æ¡ˆï¼š

```bash
# å¼€å‘æ¨¡å¼ - è‡ªåŠ¨ç”Ÿæˆæƒé™æ–‡ä»¶ï¼Œé€‚åˆå¼€å‘å’Œæµ‹è¯•
python ../UnifyPy/main.py . --config build.json --development

# ç”Ÿäº§æ¨¡å¼ - ç”¨äºå·²ç­¾ååº”ç”¨
python ../UnifyPy/main.py . --config build.json --production
```

**è‡ªåŠ¨åŒ–åŠŸèƒ½**ï¼š

- âœ… è‡ªåŠ¨ç”Ÿæˆ entitlements.plist
- âœ… è‡ªåŠ¨æ›´æ–° Info.plist æƒé™æè¿°  
- âœ… è‡ªåŠ¨ ad-hoc ä»£ç ç­¾å
- âœ… è‡ªåŠ¨å›¾æ ‡æ ¼å¼è½¬æ¢ï¼ˆPNG â†’ ICNSï¼‰

## å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### Windowså¹³å°å¸¸è§é—®é¢˜

1. **æ‰¾ä¸åˆ°Inno Setup**

   è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿å·²å®‰è£…Inno Setupï¼Œå¹¶åœ¨build.jsonä¸­æ­£ç¡®é…ç½®è·¯å¾„ï¼Œæˆ–è®¾ç½®ç¯å¢ƒå˜é‡INNO_SETUP_PATH

2. **ç¼ºå°‘éšå¼å¯¼å…¥çš„æ¨¡å—**

   è§£å†³æ–¹æ¡ˆï¼šåœ¨`additional_pyinstaller_args`ä¸­æ·»åŠ `--hidden-import=æ¨¡å—åç§°`

3. **æ‰“åŒ…åæ— æ³•æ‰¾åˆ°èµ„æºæ–‡ä»¶**

   è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿ä½¿ç”¨ç›¸å¯¹è·¯å¾„è®¿é—®èµ„æºæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨`--add-data`å‚æ•°æ­£ç¡®åŒ…å«èµ„æºæ–‡ä»¶

### macOSå¹³å°å¸¸è§é—®é¢˜

1. **åˆ›å»ºDMGå‡ºé”™**

   è§£å†³æ–¹æ¡ˆï¼šUnifyPy 2.0å†…ç½®create-dmgå·¥å…·ï¼Œå¦‚æœä»æœ‰é—®é¢˜è¯·æ£€æŸ¥macOSæƒé™è®¾ç½®

2. **ç­¾åé—®é¢˜**

   è§£å†³æ–¹æ¡ˆï¼šå¦‚æœéœ€è¦ç­¾åï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨`sign_bundle`å¹¶æä¾›æœ‰æ•ˆçš„å¼€å‘è€…èº«ä»½

3. **åŠ¨æ€åº“åŠ è½½é—®é¢˜**

   è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿ä»£ç ä¸­æ­£ç¡®å¤„ç†åº“è·¯å¾„ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨`sys._MEIPASS`è·¯å¾„

### Linuxå¹³å°å¸¸è§é—®é¢˜

1. **ç¼ºå°‘ä¾èµ–åº“**

   è§£å†³æ–¹æ¡ˆï¼šåœ¨Linuxé…ç½®ä¸­çš„`requires`å­—æ®µä¸­æ·»åŠ æ‰€éœ€çš„ç³»ç»Ÿä¾èµ–

2. **æ‰“åŒ…å·¥å…·ä¸å¯ç”¨**

   è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿å·²å®‰è£…DEBæ‰“åŒ…å·¥å…·(dpkg-dev, fakeroot)

3. **æƒé™é—®é¢˜**

   è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿è„šæœ¬æœ‰æ­£ç¡®çš„æ‰§è¡Œæƒé™ï¼Œå¯¹æŸäº›èµ„æºç›®å½•å¯èƒ½éœ€è¦ç‰¹åˆ«å¤„ç†

4. **NumPyç¼–è¯‘å¤±è´¥ï¼ˆLinuxç‰¹æœ‰é—®é¢˜ï¼‰**

   **ç—‡çŠ¶**: å‡ºç°ç¼–è¯‘é”™è¯¯ã€ç¼ºå°‘BLAS/LAPACKåº“ç­‰

   **è§£å†³æ–¹æ¡ˆ**:

   ```bash
   # æ–¹æ¡ˆ1: æ£€æŸ¥å¹¶å®‰è£…ç¼ºå¤±çš„å¼€å‘åº“
   sudo apt install -y libopenblas-dev liblapack-dev gfortran
   
   # æ–¹æ¡ˆ2: ä½¿ç”¨é¢„ç¼–è¯‘çš„wheelåŒ…ï¼ˆæ¨èï¼‰
   pip install numpy --force-reinstall
   
   # æ–¹æ¡ˆ3: è®¾ç½®æ­£ç¡®çš„ç¯å¢ƒå˜é‡
   export BLAS=openblas
   export LAPACK=openblas
   export NPY_NUM_BUILD_JOBS=4
   
   # æ–¹æ¡ˆ4: ä½¿ç”¨condaç¯å¢ƒï¼ˆæœ€ç¨³å®šï¼‰
   conda install numpy scipy openblas-devel
   ```

6. **PyInstalleråœ¨Linuxä¸Šçš„ä¾èµ–é—®é¢˜**

   **ç—‡çŠ¶**: æ‰“åŒ…åçš„ç¨‹åºåœ¨å…¶ä»–Linuxç³»ç»Ÿä¸Šæ— æ³•è¿è¡Œ

   **è§£å†³æ–¹æ¡ˆ**:

   ```bash
   # ä½¿ç”¨é™æ€é“¾æ¥
   pip install staticx
   
   # æˆ–è€…åœ¨è¾ƒè€çš„Linuxå‘è¡Œç‰ˆä¸Šæ„å»º
   # æ¨èä½¿ç”¨Ubuntu 18.04æˆ–CentOS 7ä½œä¸ºæ„å»ºç¯å¢ƒ
   ```

8. **ä¾èµ–å†²çªå¤„ç†ï¼ˆæœ€å¸¸è§é—®é¢˜ï¼‰**

   **ç—‡çŠ¶**: æ‰“åŒ…è¿‡ç¨‹ä¸­å‡ºç°æ¨¡å—å¯¼å…¥é”™è¯¯ã€ç‰ˆæœ¬å†²çªæˆ–PyInstalleråˆ†æå¤±è´¥

   **æ ¹æœ¬åŸå› **: UnifyPyå’Œç›®æ ‡é¡¹ç›®çš„ä¾èµ–ç‰ˆæœ¬ä¸å…¼å®¹æˆ–ç¯å¢ƒä¸ç»Ÿä¸€

   **è§£å†³æ–¹æ¡ˆ**:

   ```bash
   # æ–¹æ¡ˆ1: ç»Ÿä¸€condaç¯å¢ƒï¼ˆå¼ºçƒˆæ¨èï¼‰
   conda create -n unified-packaging python=3.9
   conda activate unified-packaging
   
   # å…ˆå®‰è£…UnifyPyä¾èµ–
   cd /path/to/UnifyPy
   pip install -r requirements.txt
   
   # å†å®‰è£…ç›®æ ‡é¡¹ç›®ä¾èµ–
   cd /path/to/py-xiaozhi
   pip install -r requirements.txt
   
   # éªŒè¯ç¯å¢ƒå®Œæ•´æ€§
   python -c "import rich, requests, packaging, pillow, numpy, PyQt5; print('âœ… All dependencies OK')"
   
   # æ–¹æ¡ˆ2: åœ¨ç›®æ ‡é¡¹ç›®ç¯å¢ƒä¸­è¡¥å……UnifyPyä¾èµ–
   pip install rich>=12.0 requests>=2.28 packaging>=21.0 pillow>=8.0
   
   # æ–¹æ¡ˆ3: ä½¿ç”¨requirementsåˆå¹¶æ–‡ä»¶
   cat /path/to/UnifyPy/requirements.txt requirements.txt > combined_requirements.txt
   pip install -r combined_requirements.txt
   ```

## æœ€ä½³å®è·µ

### é€šç”¨æœ€ä½³å®è·µ

1. **ç¯å¢ƒç»Ÿä¸€ç®¡ç†**ï¼šä½¿ç”¨condaåˆ›å»ºä¸“ç”¨æ‰“åŒ…ç¯å¢ƒï¼Œé¿å…ä¾èµ–å†²çª

   ```bash
   conda create -n packaging-env python=3.9
   conda activate packaging-env
   # å®‰è£…UnifyPyå’Œç›®æ ‡é¡¹ç›®çš„æ‰€æœ‰ä¾èµ–
   ```

2. **æ¸…ç†é¡¹ç›®**ï¼šæ‰“åŒ…å‰ç§»é™¤ä¸´æ—¶æ–‡ä»¶ã€ç¼“å­˜å’Œä¸å¿…è¦çš„å¤§å‹æ–‡ä»¶

3. **ä¾èµ–éªŒè¯**ï¼šç¡®ä¿UnifyPyå’Œç›®æ ‡é¡¹ç›®çš„ä¾èµ–éƒ½åœ¨åŒä¸€ç¯å¢ƒä¸­æ­£ç¡®å®‰è£…

   ```bash
   # éªŒè¯å…³é”®ä¾èµ–
   python -c "import rich, requests, packaging; print('UnifyPy dependencies OK')"
   python -c "import numpy, PyQt5; print('Target project dependencies OK')"
   ```

4. **æ™ºèƒ½è·¯å¾„ç®¡ç†**ï¼šåˆ©ç”¨UnifyPy 2.0çš„æ™ºèƒ½è·¯å¾„å¤„ç†ï¼Œé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ç›¸å¯¹è·¯å¾„

5. **éªŒè¯é…ç½®**ï¼šç¡®ä¿build.jsonä¸­çš„é…ç½®ä¸æ‚¨çš„ç¯å¢ƒä¸€è‡´

6. **å¤šå¹³å°æµ‹è¯•**ï¼šå¦‚æœæ¡ä»¶å…è®¸ï¼Œåœ¨å¤šä¸ªå¹³å°ä¸Šæµ‹è¯•æ‰“åŒ…çš„åº”ç”¨ç¨‹åº

7. **ä¿å­˜é…ç½®**ï¼šä¸ºä¸åŒçš„æ‰“åŒ…åœºæ™¯ä¿å­˜ä¸åŒç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶ï¼Œæ–¹ä¾¿å¤ç”¨

8. **ç‰ˆæœ¬ç®¡ç†**ï¼šæ¯æ¬¡å‘å¸ƒå‰æ›´æ–°ç‰ˆæœ¬å·ï¼Œä¿æŒç‰ˆæœ¬ä¸€è‡´æ€§

### UnifyPy 2.0 ç‰¹å®šæœ€ä½³å®è·µ

8. **å¯ç”¨è¯¦ç»†æ—¥å¿—**ï¼šä½¿ç”¨`--verbose`å‚æ•°ä¾¿äºé—®é¢˜æ’æŸ¥

   ```bash
   python ../UnifyPy/main.py . --config build.json --verbose
   ```

9. **åˆ©ç”¨å›æ»šç³»ç»Ÿ**ï¼šæ„å»ºå‰äº†è§£å›æ»šåŠŸèƒ½ï¼Œå¿…è¦æ—¶å¿«é€Ÿæ¢å¤

   ```bash
   # æ„å»ºå‰æŸ¥çœ‹å¯ç”¨ä¼šè¯
   python ../UnifyPy/main.py . --list-rollback
   ```

10. **macOSæƒé™é…ç½®**ï¼šä½¿ç”¨è‡ªåŠ¨æƒé™ç®¡ç†ç®€åŒ–macOSæ‰“åŒ…

    ```bash
    # å¼€å‘é˜¶æ®µä½¿ç”¨å¼€å‘æ¨¡å¼
    python ../UnifyPy/main.py . --config build.json --development
    ```

### Linuxå¹³å°ç‰¹å®šæœ€ä½³å®è·µ

12. **ç»Ÿä¸€æ‰“åŒ…ç¯å¢ƒ**ï¼šåœ¨åŒä¸€condaç¯å¢ƒä¸­å®‰è£…UnifyPyå’Œç›®æ ‡é¡¹ç›®ä¾èµ–

    ```bash
    # åˆ›å»ºä¸“ç”¨æ‰“åŒ…ç¯å¢ƒï¼ˆæ¨èï¼‰
    conda create -n packaging-env python=3.9
    conda activate packaging-env
    
    # æŒ‰é¡ºåºå®‰è£…ä¾èµ–ï¼Œé¿å…å†²çª
    pip install -r /path/to/UnifyPy/requirements.txt
    pip install -r /path/to/py-xiaozhi/requirements.txt
    
    # éªŒè¯å…³é”®ä¾èµ–
    python -c "import rich, numpy, PyQt5; print('Dependencies OK')"
    ```

13. **NumPyå¤„ç†ç­–ç•¥**ï¼šä¼˜å…ˆä½¿ç”¨é¢„ç¼–è¯‘åŒ…ï¼Œé¿å…ä¸å¿…è¦çš„æºç ç¼–è¯‘

    ```bash
    # æ£€æŸ¥NumPyçŠ¶æ€
    python -c "import numpy; print(numpy.__version__, numpy.show_config())"
    ```

14. **Linuxæ‰“åŒ…æ³¨æ„äº‹é¡¹**ï¼š
    - **DEBæ ¼å¼**: é€‚ç”¨äºDebian/Ubuntuç³»ç»Ÿçš„æ­£å¼åˆ†å‘
    - **æ„å»ºç¯å¢ƒ**: ä½¿ç”¨è¾ƒè€çš„Linuxå‘è¡Œç‰ˆæ„å»ºä»¥ç¡®ä¿å…¼å®¹æ€§
    - æ¨èï¼šUbuntu 18.04 LTS æˆ– Ubuntu 20.04 LTS
    - é¿å…ï¼šè¿‡æ–°çš„å‘è¡Œç‰ˆå¯èƒ½å¯¼è‡´å…¼å®¹æ€§é—®é¢˜
